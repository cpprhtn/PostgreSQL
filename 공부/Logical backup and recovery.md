# PostgreSQL의 논리적 백업과 복구

## 논리적 백업 개념 및 실습

### 논리적 백업이란?

- **논리적 백업**은 데이터베이스의 **구조**와 **내용**을 SQL 쿼리 형태로 저장하는 방법이다. 이는 데이터베이스의 **스키마**(테이블, 뷰, 인덱스 등)와 **데이터**를 SQL 명령어 형식으로 저장하고, 나중에 이를 이용해 다른 시스템에서 복구할 수 있게 해준다.
- **논리적 백업**은 **pg_dump** 유틸리티를 사용하여 수행된다. 이 유틸리티는 테이블, 스키마, 데이터베이스의 특정 요소를 선택적으로 백업할 수 있는 기능을 제공한다.

### 논리적 백업 방식

- **전체 백업**: 전체 데이터베이스를 백업하여 복구 시 동일한 상태로 복원한다.
- **테이블 단위 백업**: 특정 테이블만 선택하여 백업한다.
- **스키마 단위 백업**: 특정 스키마만 백업할 수 있다.
- **데이터 단위 백업**: 데이터를 제외하고 스키마만 백업하거나, 데이터를 포함하여 백업할 수 있다.

### 논리적 백업 실습

1. **전체 데이터베이스 백업**:
   전체 데이터베이스를 백업하려면 `pg_dump` 명령어를 사용한다.

   ```bash
   pg_dump my_database > my_database_backup.sql
   ```

   - `my_database`: 백업할 데이터베이스의 이름
   - `my_database_backup.sql`: 백업 파일 이름

2. **테이블 단위 백업**:
   특정 테이블만 백업하려면 `pg_dump` 명령어에 `-t` 옵션을 사용한다.

   ```bash
   pg_dump -t my_table my_database > my_table_backup.sql
   ```

   - `-t my_table`: `my_table`이라는 테이블만 백업

3. **스키마 단위 백업**:
   특정 스키마만 백업하려면 `pg_dump` 명령어에 `-n` 옵션을 사용한다.

   ```bash
   pg_dump -n my_schema my_database > my_schema_backup.sql
   ```

   - `-n my_schema`: `my_schema`라는 스키마만 백업

4. **데이터베이스를 압축하여 백업**:
   백업 파일을 압축하여 저장하려면 `pg_dump` 명령어에 `-Fc` 옵션을 추가하여 포맷을 지정할 수 있다.
   ```bash
   pg_dump -Fc my_database > my_database_backup.dump
   ```
   - `-Fc`: 커스텀 형식으로 백업을 진행해 압축된 백업 파일을 생성

### 논리적 백업의 장점

- **이식성**: SQL 형식으로 저장되므로, 다른 시스템에 쉽게 이식할 수 있다.
- **부분 백업**: 특정 테이블이나 스키마만 선택적으로 백업할 수 있어 유연한 관리가 가능하다.
- **확장성**: 백업 파일을 수정하여 특정 데이터만 복원하는 등의 처리가 가능하다.

## 논리적 복구 개념 및 실습

### 논리적 복구란?

- **논리적 복구**는 논리적 백업 파일을 사용하여 데이터베이스를 복구하는 방법이다. 백업이 SQL 명령어 형태로 저장되므로, 복구 시 해당 명령어를 실행하여 데이터베이스를 재구성한다.
- 복구는 **pg_restore** 또는 **psql** 명령어를 통해 수행된다. **pg_restore**는 커스텀 형식으로 백업된 파일을 복구할 때 사용하고, **psql**은 SQL 스크립트 파일을 실행하여 복구할 때 사용한다.

### 논리적 복구 방식

- **전체 복구**: 백업한 전체 데이터베이스를 복원한다.
- **부분 복구**: 특정 테이블이나 스키마만 복원한다.
- **데이터 복원**: 특정 데이터만 복원하거나, 데이터와 스키마를 분리하여 복원할 수 있다.

### 논리적 복구 실습

1. **전체 데이터베이스 복구**:
   전체 백업 파일을 사용하여 데이터베이스를 복구하려면 `psql` 또는 `pg_restore`를 사용한다. SQL 형식으로 백업된 파일을 복구할 때는 `psql`을 사용한다.

   ```bash
   psql my_database < my_database_backup.sql
   ```

   - `my_database`: 복구할 데이터베이스 이름
   - `my_database_backup.sql`: 복구할 백업 파일 이름

2. **커스텀 형식 백업 복구**:
   커스텀 형식으로 백업한 파일은 `pg_restore` 명령어로 복구할 수 있다.

   ```bash
   pg_restore -d my_database my_database_backup.dump
   ```

   - `-d my_database`: 복구할 데이터베이스 이름
   - `my_database_backup.dump`: 복구할 백업 파일

3. **부분 복구 (특정 테이블 복구)**:
   특정 테이블만 복구하려면 `pg_restore` 명령어에 `-t` 옵션을 사용하여 복구할 테이블을 지정한다.

   ```bash
   pg_restore -d my_database -t my_table my_table_backup.dump
   ```

   - `-t my_table`: 복구할 테이블 지정

4. **복구 시 데이터 덮어쓰기 방지**:
   만약 기존 테이블에 데이터가 존재하고, 복구 시 덮어쓰기를 방지하고 싶다면 `--clean` 옵션을 추가할 수 있다.
   ```bash
   pg_restore -d my_database --clean my_database_backup.dump
   ```
   - `--clean`: 복구 전에 기존 객체(테이블 등)를 삭제하고 복원

### 논리적 복구의 장점

- **복구 유연성**: SQL 파일 형식으로 저장된 백업은 복구 시 데이터베이스를 유연하게 재구성할 수 있게 한다.
- **이식성**: SQL 명령어로 작성된 복구 파일은 다른 시스템으로 쉽게 전송하여 복원할 수 있다.
- **부분 복구**: 전체 데이터베이스 복구 외에도 특정 테이블이나 스키마만 복원할 수 있어 세밀한 복구가 가능하다.

## 논리적 백업과 복구 시 고려사항

- **백업 주기**: 주기적인 백업을 통해 데이터 손실을 최소화한다.
- **복구 테스트**: 백업 후 복구 테스트를 수행하여, 실제 복구 시 문제가 발생하지 않도록 한다.
- **데이터베이스 잠금**: 논리적 백업은 주로 데이터베이스의 잠금을 일으키지 않지만, 대규모 테이블에서 백업 시 성능에 영향을 줄 수 있으므로 주의가 필요하다.
- **백업 파일 보안**: 백업 파일은 민감한 데이터를 포함할 수 있으므로, 백업 파일에 대한 접근을 적절히 관리한다.
