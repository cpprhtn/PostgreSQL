# 물리적 백업과 복구

## 물리적 백업 개념 및 실습

### 물리적 백업이란?

- **물리적 백업**은 데이터베이스 파일 자체를 복사하는 방식의 백업이다. 데이터베이스의 물리적 파일(데이터 파일, 트랜잭션 로그 파일 등)을 그대로 백업하여, 시스템이 완전한 상태로 복구될 수 있도록 한다.
- 물리적 백업은 **PostgreSQL 데이터베이스의 디렉토리 구조**(예: 데이터베이스 데이터 디렉토리)에 저장된 파일을 그대로 복사하는 방식이므로, **전체 데이터베이스의 상태**를 백업한다. 이를 통해 데이터베이스를 신속하고 효율적으로 복구할 수 있다.

### 물리적 백업 방법

- **파일 시스템 백업**: 데이터베이스가 실행 중일 때 데이터베이스 파일을 복사하는 방법이다. 이 방법은 **온라인 백업**이라 불리며, 데이터베이스가 `archive_mode` 상태일 때 사용된다.
- **pg_basebackup**: PostgreSQL은 `pg_basebackup` 유틸리티를 제공하여 **물리적 백업**을 간단히 할 수 있다. 이 유틸리티는 서버를 멈추지 않고도 **온라인 백업**을 수행할 수 있다.

### 물리적 백업 실습

1. **pg_basebackup을 이용한 물리적 백업**

   - `pg_basebackup`을 사용하여 **물리적 백업**을 수행할 수 있다.

   ```bash
   pg_basebackup -D /path/to/backup_dir -Ft -z -P
   ```

   - `-D`: 백업을 저장할 디렉토리 경로 지정
   - `-Ft`: 백업을 tar 형식으로 생성
   - `-z`: 백업 파일 압축
   - `-P`: 백업 진행 상황을 표시

2. **데이터베이스 파일을 복사하여 백업**

   - PostgreSQL의 데이터 디렉토리(`/var/lib/postgresql/data` 등)에 있는 파일을 직접 복사하여 백업할 수 있다.

   ```bash
   cp -r /var/lib/postgresql/data /path/to/backup_dir
   ```

3. **파일 시스템 백업 사용**
   - 데이터베이스가 **archive_mode** 설정된 상태에서 **파일 시스템 백업**을 사용하여, 트랜잭션 로그와 데이터 파일을 동시에 백업한다.

### 물리적 백업의 장점

- **빠른 복구**: 물리적 백업은 파일 자체를 복사하므로, 데이터베이스 복구가 매우 빠르다.
- **전체 백업**: 모든 데이터베이스 데이터를 포함하므로 복구 시 완전한 시스템 복구가 가능하다.
- **쉬운 관리**: `pg_basebackup`을 사용하여 매우 간단하게 물리적 백업을 할 수 있다.

## 물리적 복구 개념 및 실습

### 물리적 복구란?

- **물리적 복구**는 물리적 백업 파일을 이용하여 PostgreSQL 데이터베이스를 복원하는 작업이다. 복구는 **백업된 데이터 파일**을 원래 위치로 복사하거나, `pg_restore`를 이용해 복원할 수 있다.
- 물리적 복구는 **pg_basebackup**을 사용하여 백업한 데이터를 복원하는 방식이 일반적이다.

### 물리적 복구 방법

- **파일 복사**: 물리적 백업에서 복사한 데이터 파일을 원래 디렉토리에 복사하여 복원할 수 있다. 이때, PostgreSQL 서버가 실행 중이지 않아야 한다.
- **pg_basebackup을 이용한 복원**: `pg_basebackup`을 사용하여 백업된 데이터베이스를 복원할 수 있다.

### 물리적 복구 실습

1. **파일 시스템 백업 복원**

   - 데이터베이스가 중지된 상태에서, 백업된 데이터 파일을 복사하여 복원한다.

   ```bash
   cp -r /path/to/backup_dir /var/lib/postgresql/data
   ```

   - PostgreSQL 서버를 재시작하여 복원된 데이터를 사용할 수 있다.

2. **pg_basebackup을 이용한 복원**
   - `pg_basebackup`을 사용하여 백업된 데이터를 복원하려면, 다음과 같은 명령어를 사용한다.
   ```bash
   pg_basebackup -D /var/lib/postgresql/data -Fp -X stream
   ```
   - `-D`: 복원할 데이터베이스 디렉토리
   - `-Fp`: 평범한 파일 형식으로 복원
   - `-X stream`: 트랜잭션 로그 스트리밍을 사용하여 복원

### 물리적 복구의 장점

- **빠르고 효율적**: 물리적 복구는 전체 데이터베이스의 상태를 그대로 복원하므로 복구가 빠르고 효율적이다.
- **전체 복구**: 물리적 복구는 데이터베이스의 모든 데이터를 복구하므로 완전한 복구가 가능하다.

## PITR(Point-in-Time Recovery) 개념 및 실습

### PITR(Point-in-Time Recovery)란?

- **PITR**은 특정 시점에 데이터를 복구할 수 있는 방법이다. 이 방법은 **Write Ahead Logging (WAL)**을 사용하여 트랜잭션 로그를 기반으로 복구 작업을 수행한다.
- **PITR**을 통해, 데이터베이스가 손상되거나 오류가 발생한 시점을 기준으로 복구할 수 있다. 이를 통해 데이터베이스의 정확한 시점으로 되돌릴 수 있다.

### PITR을 위한 준비 사항

- **archive_mode**: WAL 로그를 보관하기 위해서는 `archive_mode`를 활성화하고, 로그를 저장할 디렉토리 경로를 설정해야 한다.
- **archive_command**: `archive_mode`를 활성화한 후에는 `archive_command`를 설정하여 WAL 로그 파일을 외부로 저장한다.
- **restore_command**: PITR을 수행할 때 WAL 로그를 복구할 명령어를 설정한다.

### PITR 실습

1. **archive_mode 설정**

   - PostgreSQL의 `postgresql.conf` 파일에서 `archive_mode`와 `archive_command`를 설정하여 WAL 로그를 아카이브한다.

   ```bash
   archive_mode = on
   archive_command = 'cp %p /path/to/archive/%f'
   ```

   - `%p`는 로그 파일의 경로를, `%f`는 로그 파일 이름을 나타낸다.

2. **WAL 아카이브 설정**

   - `archive_command`가 제대로 동작하는지 확인하기 위해, WAL 파일이 지정된 디렉토리에 아카이브되는지 체크한다.

3. **PITR을 위한 복구 준비**

   - 복구할 시점에 해당하는 WAL 로그 파일을 준비한다.
   - `restore_command`를 설정하여 복구 중에 필요한 WAL 로그를 복원할 수 있도록 한다.

4. **PITR을 통한 복구**
   - 데이터베이스가 손상되었거나, 복원하고자 하는 시점으로 되돌리려면 `recovery.conf` 파일을 생성하고, `restore_command`를 설정한다.
   ```bash
   restore_command = 'cp /path/to/archive/%f %p'
   ```
   - PostgreSQL 서버를 재시작하여 복구 작업을 시작한다.

### PITR의 장점

- **시점 복구**: 특정 시점으로 데이터베이스를 복원할 수 있어, 실수로 인한 데이터 손실을 최소화할 수 있다.
- **트랜잭션 무결성**: WAL 로그를 통해 트랜잭션 무결성을 보장하면서 복구할 수 있다.
